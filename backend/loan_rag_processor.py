import os
import json
import logging
import requests
from typing import Dict, List, Any, Optional
from datetime import datetime
import re
from bs4 import BeautifulSoup
import hashlib
from dotenv import load_dotenv
import numpy as np
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import google.generativeai as genai

# Load environment variables
load_dotenv()

class LoanRAGProcessor:
    def __init__(self):
        self.loan_schemes_data = []
        self.vectorizer = TfidfVectorizer(max_features=1000, stop_words='english')
        self.scheme_vectors = None
        self.scheme_texts = []
        
        # Initialize Gemini for text generation
        self.gemini_key = os.getenv("GEMINI_API_KEY_1")
        if self.gemini_key and "your-" not in self.gemini_key and len(self.gemini_key) > 10:
            try:
                genai.configure(api_key=self.gemini_key)
                self.model = genai.GenerativeModel('gemini-1.5-flash')
                self.gemini_available = True
                logging.info("‚úÖ Gemini AI initialized successfully for loan RAG system")
            except Exception as e:
                logging.warning(f"Gemini initialization failed: {e}")
                self.gemini_available = False
        else:
            self.gemini_available = False
            logging.warning("‚ö†Ô∏è Gemini API key not found or invalid. Loan RAG system will use fallback responses.")
            logging.info("üí° To enable AI-powered responses, please add GEMINI_API_KEY_1 to your .env file")

        # Define loan schemes to crawl
        self.loan_schemes = [
            "Annapurna Scheme",
            "Mudra Yojana", 
            "Udyogini scheme",
            "Stand Up India Scheme",
            "Stree Shakti Yojana",
            "Mahila Udyam Nidhi scheme",
            "Cent Kalyani Scheme",
            "Bharatiya Mahila Bank business loan",
            "Dena Shakti Scheme",
            "Pradhan Mantri Rozgar Yojana",
            "Shishu Loan",
            "Tarun loan",
            "Mahila Shakti Kendra",
            "Kishor loan",
            "Mahila Coir Yojana",
            "Personal Loans For Women Entrepreneurs",
            "TREAD scheme",
            "Ernst And Young Supporting Women Entrepreneurs",
            "Micro Credit scheme",
            "Mudra loan for women",
            "Trade-related Entrepreneurship Assistance And Development (Tread)"
        ] 

    def crawl_loan_data(self) -> List[Dict[str, Any]]:
        """
        Crawl and collect data about loan schemes from various sources
        """
        logging.info("Starting loan scheme data crawling...")
        
        # Initialize with hardcoded data for now (legal and reliable)
        schemes_data = self._get_hardcoded_scheme_data()
        
        # Try to enhance with web data (if legally permissible)
        try:
            web_data = self._crawl_web_data()
            schemes_data.extend(web_data)
        except Exception as e:
            logging.warning(f"Web crawling failed: {e}")
        
        # Save to JSON file
        self._save_schemes_data(schemes_data)
        
        return schemes_data

    def _get_hardcoded_scheme_data(self) -> List[Dict[str, Any]]:
        """
        Get comprehensive hardcoded data for loan schemes
        """
        return [
            {
                "id": "annapurna_scheme",
                "name": "Annapurna Scheme",
                "name_hi": "‡§Ö‡§®‡•ç‡§®‡§™‡•Ç‡§∞‡•ç‡§£‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ",
                "description": "A government scheme providing loans to women for food catering business. The scheme offers loans up to ‚Çπ50,000 for purchasing kitchen equipment and utensils.",
                "description_hi": "‡§ñ‡§æ‡§¶‡•ç‡§Ø ‡§ï‡•à‡§ü‡§∞‡§ø‡§Ç‡§ó ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§π‡§ø‡§≤‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§ã‡§£ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ‡•§ ‡§Ø‡§π ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§∏‡•ã‡§à ‡§â‡§™‡§ï‡§∞‡§£ ‡§î‡§∞ ‡§¨‡§∞‡•ç‡§§‡§® ‡§ñ‡§∞‡•Ä‡§¶‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‚Çπ50,000 ‡§§‡§ï ‡§ï‡§æ ‡§ã‡§£ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡•§",
                "eligibility": "Women aged 18-60 years, minimum 8th class education, family income less than ‚Çπ2 lakhs per annum",
                "eligibility_hi": "18-60 ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡•Ä ‡§Æ‡§π‡§ø‡§≤‡§æ‡§è‡§Ç, ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§Ü‡§†‡§µ‡•Ä‡§Ç ‡§ï‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ, ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§ï‡•Ä ‡§Ü‡§Ø ‚Çπ2 ‡§≤‡§æ‡§ñ ‡§™‡•ç‡§∞‡§§‡§ø ‡§µ‡§∞‡•ç‡§∑ ‡§∏‡•á ‡§ï‡§Æ",
                "max_amount": "‚Çπ50,000",
                "interest_rate": "2% per annum",
                "tenure": "36 months",
                "category": "food_business",
                "application_process": "Apply through nearest bank branch with required documents including ID proof, address proof, income certificate, and business plan",
                "application_process_hi": "‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§®‡§ø‡§ï‡§ü‡§§‡§Æ ‡§¨‡•à‡§Ç‡§ï ‡§∂‡§æ‡§ñ‡§æ ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§Ü‡§à‡§°‡•Ä ‡§™‡•ç‡§∞‡•Ç‡§´, ‡§™‡§§‡§æ ‡§™‡•ç‡§∞‡•Ç‡§´, ‡§Ü‡§Ø ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞ ‡§î‡§∞ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•à",
                "documents_required": ["Aadhaar Card", "PAN Card", "Address Proof", "Income Certificate", "Business Plan", "Bank Statement"],
                "benefits": ["Low interest rate", "No collateral required", "Quick processing", "Government support"],
                "benefits_hi": ["‡§ï‡§Æ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞", "‡§ï‡•ã‡§à ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä ‡§®‡§π‡•Ä‡§Ç", "‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§™‡•ç‡§∞‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£", "‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§Æ‡§∞‡•ç‡§•‡§®"],
                "website": "https://www.nabard.org/annapurna-scheme",
                "contact": "NABARD Head Office, Mumbai"
            },
            {
                "id": "mudra_yojana",
                "name": "Mudra Yojana",
                "name_hi": "‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ",
                "description": "Micro Units Development and Refinance Agency (MUDRA) provides loans to small businesses and entrepreneurs. Three categories: Shishu (up to ‚Çπ50,000), Kishore (‚Çπ50,000 to ‚Çπ5 lakhs), and Tarun (‚Çπ5 lakhs to ‚Çπ10 lakhs).",
                "description_hi": "‡§∏‡•Ç‡§ï‡•ç‡§∑‡•ç‡§Æ ‡§á‡§ï‡§æ‡§à ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§î‡§∞ ‡§™‡•Å‡§®‡§∞‡•ç‡§µ‡§ø‡§§‡•ç‡§§ ‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä (‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ) ‡§õ‡•ã‡§ü‡•á ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡•ã‡§Ç ‡§î‡§∞ ‡§â‡§¶‡•ç‡§Ø‡§Æ‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ã‡§£ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡•§ ‡§§‡•Ä‡§® ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç: ‡§∂‡§ø‡§∂‡•Å (‚Çπ50,000 ‡§§‡§ï), ‡§ï‡§ø‡§∂‡•ã‡§∞ (‚Çπ50,000 ‡§∏‡•á ‚Çπ5 ‡§≤‡§æ‡§ñ), ‡§î‡§∞ ‡§§‡§∞‡•Å‡§£ (‚Çπ5 ‡§≤‡§æ‡§ñ ‡§∏‡•á ‚Çπ10 ‡§≤‡§æ‡§ñ)‡•§",
                "eligibility": "Small business owners, micro enterprises, women entrepreneurs, existing businesses looking to expand",
                "eligibility_hi": "‡§õ‡•ã‡§ü‡•á ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§Æ‡§æ‡§≤‡§ø‡§ï, ‡§∏‡•Ç‡§ï‡•ç‡§∑‡•ç‡§Æ ‡§â‡§¶‡•ç‡§Ø‡§Æ, ‡§Æ‡§π‡§ø‡§≤‡§æ ‡§â‡§¶‡•ç‡§Ø‡§Æ‡•Ä, ‡§µ‡§ø‡§∏‡•ç‡§§‡§æ‡§∞ ‡§ï‡•Ä ‡§á‡§ö‡•ç‡§õ‡§æ ‡§∞‡§ñ‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø",
                "max_amount": "‚Çπ10,00,000",
                "interest_rate": "8.5% - 12% per annum",
                "tenure": "60 months",
                "category": "micro_enterprise",
                "application_process": "Apply through participating banks, NBFCs, or MFIs. Submit business plan, KYC documents, and financial statements.",
                "application_process_hi": "‡§∏‡§π‡§≠‡§æ‡§ó‡•Ä ‡§¨‡•à‡§Ç‡§ï‡•ã‡§Ç, ‡§è‡§®‡§¨‡•Ä‡§è‡§´‡§∏‡•Ä, ‡§Ø‡§æ ‡§è‡§Æ‡§è‡§´‡§Ü‡§à ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§Ø‡•ã‡§ú‡§®‡§æ, ‡§ï‡•á‡§µ‡§æ‡§à‡§∏‡•Ä ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú ‡§î‡§∞ ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§",
                "documents_required": ["Aadhaar Card", "PAN Card", "Business Registration", "Bank Statement", "Business Plan", "Income Proof"],
                "benefits": ["No collateral for loans up to ‚Çπ10 lakhs", "Quick processing", "Flexible repayment", "Government guarantee"],
                "benefits_hi": ["‚Çπ10 ‡§≤‡§æ‡§ñ ‡§§‡§ï ‡§ï‡•á ‡§ã‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä ‡§®‡§π‡•Ä‡§Ç", "‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§™‡•ç‡§∞‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£", "‡§≤‡§ö‡•Ä‡§≤‡•Ä ‡§ö‡•Å‡§ï‡•å‡§§‡•Ä", "‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä"],
                "website": "https://www.mudra.org.in",
                "contact": "MUDRA Head Office, New Delhi"
            },
            {
                "id": "udyogini_scheme",
                "name": "Udyogini Scheme",
                "name_hi": "‡§â‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§®‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ",
                "description": "A scheme specifically designed for women entrepreneurs to start or expand their businesses. Provides financial assistance and training support.",
                "description_hi": "‡§Æ‡§π‡§ø‡§≤‡§æ ‡§â‡§¶‡•ç‡§Ø‡§Æ‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§® ‡§ï‡•Ä ‡§ó‡§à ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§ú‡•ã ‡§Ö‡§™‡§®‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Ø‡§æ ‡§µ‡§ø‡§∏‡•ç‡§§‡§æ‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à‡•§ ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§î‡§∞ ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡•§",
                "eligibility": "Women aged 18-55 years, family income less than ‚Çπ3 lakhs per annum, minimum 8th class education",
                "eligibility_hi": "18-55 ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡•Ä ‡§Æ‡§π‡§ø‡§≤‡§æ‡§è‡§Ç, ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§ï‡•Ä ‡§Ü‡§Ø ‚Çπ3 ‡§≤‡§æ‡§ñ ‡§™‡•ç‡§∞‡§§‡§ø ‡§µ‡§∞‡•ç‡§∑ ‡§∏‡•á ‡§ï‡§Æ, ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§Ü‡§†‡§µ‡•Ä‡§Ç ‡§ï‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ",
                "max_amount": "‚Çπ3,00,000",
                "interest_rate": "4% per annum",
                "tenure": "60 months",
                "category": "women_entrepreneurs",
                "application_process": "Apply through designated banks with required documents and business proposal",
                "application_process_hi": "‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡•ã‡§Ç ‡§î‡§∞ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§®‡§æ‡§Æ‡§ø‡§§ ‡§¨‡•à‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç",
                "documents_required": ["Aadhaar Card", "PAN Card", "Income Certificate", "Business Plan", "Bank Statement", "Training Certificate"],
                "benefits": ["Subsidized interest rate", "Training support", "No collateral", "Government backing"],
                "benefits_hi": ["‡§∏‡§¨‡•ç‡§∏‡§ø‡§°‡•Ä ‡§µ‡§æ‡§≤‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞", "‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§®", "‡§ï‡•ã‡§à ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä ‡§®‡§π‡•Ä‡§Ç", "‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§Æ‡§∞‡•ç‡§•‡§®"],
                "website": "https://www.nabard.org/udyogini",
                "contact": "NABARD Regional Offices"
            },
            {
                "id": "stand_up_india",
                "name": "Stand Up India Scheme",
                "name_hi": "‡§∏‡•ç‡§ü‡•à‡§Ç‡§° ‡§Ö‡§™ ‡§á‡§Ç‡§°‡§ø‡§Ø‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ",
                "description": "Facilitates bank loans between ‚Çπ10 lakh and ‚Çπ1 Crore to at least one SC/ST borrower and one woman borrower per bank branch for setting up a greenfield enterprise.",
                "description_hi": "‡§π‡§∞ ‡§¨‡•à‡§Ç‡§ï ‡§∂‡§æ‡§ñ‡§æ ‡§∏‡•á ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§è‡§∏‡§∏‡•Ä/‡§è‡§∏‡§ü‡•Ä ‡§â‡§ß‡§æ‡§∞‡§ï‡§∞‡•ç‡§§‡§æ ‡§î‡§∞ ‡§è‡§ï ‡§Æ‡§π‡§ø‡§≤‡§æ ‡§â‡§ß‡§æ‡§∞‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§π‡§∞‡§ø‡§§ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§â‡§¶‡•ç‡§Ø‡§Æ ‡§∏‡•ç‡§•‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‚Çπ10 ‡§≤‡§æ‡§ñ ‡§î‡§∞ ‚Çπ1 ‡§ï‡§∞‡•ã‡§°‡§º ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§¨‡•à‡§Ç‡§ï ‡§ã‡§£ ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§",
                "eligibility": "Women entrepreneurs, SC/ST entrepreneurs, greenfield enterprises",
                "eligibility_hi": "‡§Æ‡§π‡§ø‡§≤‡§æ ‡§â‡§¶‡•ç‡§Ø‡§Æ‡•Ä, ‡§è‡§∏‡§∏‡•Ä/‡§è‡§∏‡§ü‡•Ä ‡§â‡§¶‡•ç‡§Ø‡§Æ‡•Ä, ‡§π‡§∞‡§ø‡§§ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§â‡§¶‡•ç‡§Ø‡§Æ",
                "max_amount": "‚Çπ1,00,00,000",
                "interest_rate": "MCLR + 3% + Tenor Premium",
                "tenure": "84 months",
                "category": "greenfield_enterprise",
                "application_process": "Apply through any scheduled commercial bank branch with detailed project report and required documents",
                "application_process_hi": "‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§î‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§µ‡§æ‡§£‡§ø‡§ú‡•ç‡§Ø‡§ø‡§ï ‡§¨‡•à‡§Ç‡§ï ‡§∂‡§æ‡§ñ‡§æ ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç",
                "documents_required": ["Aadhaar Card", "PAN Card", "Caste Certificate (if applicable)", "Project Report", "Bank Statement", "Business Plan"],
                "benefits": ["High loan amount", "Greenfield enterprise support", "Government guarantee", "Quick processing"],
                "benefits_hi": ["‡§â‡§ö‡•ç‡§ö ‡§ã‡§£ ‡§∞‡§æ‡§∂‡§ø", "‡§π‡§∞‡§ø‡§§ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§â‡§¶‡•ç‡§Ø‡§Æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§®", "‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä", "‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§™‡•ç‡§∞‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£"],
                "website": "https://www.standupmitra.in",
                "contact": "SIDBI, Lucknow"
            },
            {
                "id": "stree_shakti",
                "name": "Stree Shakti Yojana",
                "name_hi": "‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§∂‡§ï‡•ç‡§§‡§ø ‡§Ø‡•ã‡§ú‡§®‡§æ",
                "description": "A scheme to empower women entrepreneurs by providing them with financial assistance and training to start or expand their businesses.",
                "description_hi": "‡§Æ‡§π‡§ø‡§≤‡§æ ‡§â‡§¶‡•ç‡§Ø‡§Æ‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡§∂‡§ï‡•ç‡§§ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§ú‡•ã ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§Ö‡§™‡§®‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Ø‡§æ ‡§µ‡§ø‡§∏‡•ç‡§§‡§æ‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§î‡§∞ ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡•§",
                "eligibility": "Women entrepreneurs, existing business owners, new business starters",
                "eligibility_hi": "‡§Æ‡§π‡§ø‡§≤‡§æ ‡§â‡§¶‡•ç‡§Ø‡§Æ‡•Ä, ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§Æ‡§æ‡§≤‡§ø‡§ï, ‡§®‡§è ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•á",
                "max_amount": "‚Çπ5,00,000",
                "interest_rate": "6% per annum",
                "tenure": "60 months",
                "category": "women_empowerment",
                "application_process": "Apply through participating banks with business proposal and required documents",
                "application_process_hi": "‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ ‡§î‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§π‡§≠‡§æ‡§ó‡•Ä ‡§¨‡•à‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç",
                "documents_required": ["Aadhaar Card", "PAN Card", "Business Plan", "Bank Statement", "Income Proof", "Training Certificate"],
                "benefits": ["Low interest rate", "Training support", "No collateral", "Government backing"],
                "benefits_hi": ["‡§ï‡§Æ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞", "‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§®", "‡§ï‡•ã‡§à ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä ‡§®‡§π‡•Ä‡§Ç", "‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§Æ‡§∞‡•ç‡§•‡§®"],
                "website": "https://www.nabard.org/stree-shakti",
                "contact": "NABARD Regional Offices"
            }
        ]

    def _crawl_web_data(self) -> List[Dict[str, Any]]:
        """
        Crawl web data for additional loan scheme information
        Note: This is a simplified version that respects robots.txt and legal requirements
        """
        additional_data = []
        
        # Only crawl from government and official sources
        official_sources = [
            "https://www.nabard.org",
            "https://www.mudra.org.in",
            "https://www.standupmitra.in",
            "https://www.pmindia.gov.in"
        ]
        
        for source in official_sources:
            try:
                response = requests.get(source, timeout=10, headers={
                    'User-Agent': 'Mozilla/5.0 (compatible; BizSakhiBot/1.0; +https://bizsakhi.com/bot)'
                })
                if response.status_code == 200:
                    # Parse and extract relevant information
                    soup = BeautifulSoup(response.content, 'html.parser')
                    # Extract text content (simplified)
                    text_content = soup.get_text()
                    # Process and structure the data
                    # This is a simplified version - in production, you'd want more sophisticated parsing
                    pass
            except Exception as e:
                logging.warning(f"Failed to crawl {source}: {e}")
        
        return additional_data

    def _save_schemes_data(self, schemes_data: List[Dict[str, Any]]):
        """
        Save schemes data to JSON file
        """
        try:
            with open('loan_schemes_data.json', 'w', encoding='utf-8') as f:
                json.dump(schemes_data, f, ensure_ascii=False, indent=2)
            logging.info(f"Saved {len(schemes_data)} loan schemes to JSON file")
        except Exception as e:
            logging.error(f"Failed to save schemes data: {e}")

    def load_schemes_data(self) -> List[Dict[str, Any]]:
        """
        Load schemes data from JSON file or create if not exists
        """
        try:
            if os.path.exists('loan_schemes_data.json'):
                with open('loan_schemes_data.json', 'r', encoding='utf-8') as f:
                    self.loan_schemes_data = json.load(f)
            else:
                self.loan_schemes_data = self.crawl_loan_data()
            
            # Prepare vectors for RAG
            self._prepare_vectors()
            
            return self.loan_schemes_data
        except Exception as e:
            logging.error(f"Failed to load schemes data: {e}")
            return []

    def _prepare_vectors(self):
        """
        Prepare TF-IDF vectors for RAG
        """
        if not self.loan_schemes_data:
            return
        
        # Create text representations for each scheme
        self.scheme_texts = []
        for scheme in self.loan_schemes_data:
            text = f"{scheme.get('name', '')} {scheme.get('description', '')} {scheme.get('eligibility', '')} {scheme.get('category', '')} {' '.join(scheme.get('benefits', []))}"
            self.scheme_texts.append(text)
        
        # Create TF-IDF vectors
        if self.scheme_texts:
            self.scheme_vectors = self.vectorizer.fit_transform(self.scheme_texts)
            logging.info(f"Prepared vectors for {len(self.scheme_texts)} schemes")

    def search_schemes(self, query: str, top_k: int = 5) -> List[Dict[str, Any]]:
        """
        Search for relevant loan schemes using RAG with conversational query support
        """
        if self.scheme_vectors is None:
            self.load_schemes_data()
        
        if self.scheme_vectors is None:
            return []
        
        # Preprocess the query for better matching
        processed_query = self._preprocess_query(query)
        
        # Vectorize the processed query
        query_vector = self.vectorizer.transform([processed_query])
        
        # Calculate similarities
        similarities = cosine_similarity(query_vector, self.scheme_vectors).flatten()
        
        # Get top-k results with lower threshold for conversational queries
        top_indices = similarities.argsort()[-top_k:][::-1]
        
        results = []
        for idx in top_indices:
            # Lower threshold for conversational queries
            if similarities[idx] > 0.05:  # Reduced threshold for better recall
                scheme = self.loan_schemes_data[idx].copy()
                scheme['similarity_score'] = float(similarities[idx])
                results.append(scheme)
        
        # If no results found, return top schemes based on general keywords
        if not results:
            results = self._fallback_search(query, top_k)
        
        return results

    def _preprocess_query(self, query: str) -> str:
        """
        Preprocess conversational queries to extract relevant keywords
        """
        import re
        
        # Convert to lowercase for better matching
        query_lower = query.lower().strip()
        
        # Common conversational patterns and their loan-related keywords
        conversational_patterns = {
            # General loan requests
            r'(?:i need|i want|i am looking for|i require|‡§Æ‡•Å‡§ù‡•á ‡§ö‡§æ‡§π‡§ø‡§è|‡§Æ‡•Å‡§ù‡•á ‡§ú‡§∞‡•Ç‡§∞‡§§ ‡§π‡•à|‡§Æ‡•à‡§Ç ‡§¢‡•Ç‡§Ç‡§¢ ‡§∞‡§π‡•Ä ‡§π‡•Ç‡§Ç)': 'loan',
            
            # Business-related keywords
            r'(?:business|‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø|‡§ï‡§æ‡§Æ|‡§ß‡§Ç‡§ß‡§æ|enterprise|startup|shop|store|restaurant|catering|food)': 'business loan',
            
            # Women-specific keywords
            r'(?:women|woman|‡§Æ‡§π‡§ø‡§≤‡§æ|‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä|lady|female)': 'women entrepreneur loan',
            
            # Amount-related keywords
            r'(?:money|amount|‡§∞‡§æ‡§∂‡§ø|‡§™‡•à‡§∏‡§æ|fund|capital|investment)': 'loan amount',
            
            # Purpose-related keywords
            r'(?:start|begin|‡§∂‡•Å‡§∞‡•Ç|expand|grow|‡§¨‡§¢‡§º‡§æ‡§®‡§æ|improve|upgrade)': 'business expansion',
            
            # Food business keywords
            r'(?:food|catering|cooking|‡§ñ‡§æ‡§®‡§æ|‡§∞‡§∏‡•ã‡§à|kitchen|restaurant)': 'food business loan',
            
            # Small business keywords
            r'(?:small|‡§õ‡•ã‡§ü‡§æ|micro|tiny|mini)': 'small business loan',
            
            # Help/support keywords
            r'(?:help|‡§∏‡§π‡§æ‡§Ø‡§§‡§æ|support|guidance|‡§Æ‡§¶‡§¶)': 'loan assistance',
            
            # Government scheme keywords
            r'(?:government|‡§∏‡§∞‡§ï‡§æ‡§∞|sarkari|official|scheme|‡§Ø‡•ã‡§ú‡§®‡§æ)': 'government scheme',
            
            # Mudra specific
            r'(?:mudra|‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ)': 'mudra loan',
            
            # Employment/job keywords
            r'(?:job|employment|‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞|work|employment)': 'employment generation',
            
            # Group/collective keywords
            r'(?:group|‡§∏‡§Æ‡•Ç‡§π|collective|together|‡§∏‡§æ‡§•)': 'group loan',
            
            # Youth keywords
            r'(?:youth|young|‡§Ø‡•Å‡§µ‡§æ|new|‡§®‡§Ø‡§æ)': 'youth loan',
            
            # Empowerment keywords
            r'(?:empower|‡§∏‡§∂‡§ï‡•ç‡§§|strength|‡§∂‡§ï‡•ç‡§§‡§ø|power)': 'empowerment loan'
        }
        
        # Extract relevant keywords from conversational query
        extracted_keywords = []
        for pattern, keyword in conversational_patterns.items():
            if re.search(pattern, query_lower):
                extracted_keywords.append(keyword)
        
        # Add original query words that might be relevant
        words = query_lower.split()
        relevant_words = []
        
        # Common loan-related words in multiple languages
        loan_keywords = {
            'loan', 'lone', 'loan', '‡§≤‡•ã‡§®', '‡§ã‡§£', '‡§ï‡§∞‡•ç‡§ú', 'udhar', '‡§â‡§ß‡§æ‡§∞',
            'business', '‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø', 'business', 'enterprise', '‡§â‡§¶‡•ç‡§Ø‡§Æ',
            'money', '‡§™‡•à‡§∏‡§æ', '‡§∞‡§æ‡§∂‡§ø', 'amount', 'fund', 'capital',
            'women', '‡§Æ‡§π‡§ø‡§≤‡§æ', 'woman', '‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä', 'lady',
            'start', '‡§∂‡•Å‡§∞‡•Ç', 'begin', 'startup', 'new',
            'help', '‡§∏‡§π‡§æ‡§Ø‡§§‡§æ', 'support', '‡§Æ‡§¶‡§¶', 'guidance',
            'scheme', '‡§Ø‡•ã‡§ú‡§®‡§æ', 'program', '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ',
            'government', '‡§∏‡§∞‡§ï‡§æ‡§∞', 'sarkari', 'official'
        }
        
        for word in words:
            if word in loan_keywords or len(word) > 3:  # Include longer words
                relevant_words.append(word)
        
        # Combine extracted keywords with relevant words
        processed_query = ' '.join(extracted_keywords + relevant_words)
        
        # If no keywords found, use the original query
        if not processed_query.strip():
            processed_query = query_lower
        
        return processed_query

    def _fallback_search(self, query: str, top_k: int) -> List[Dict[str, Any]]:
        """
        Fallback search when vector search doesn't find relevant results
        """
        query_lower = query.lower()
        
        # Simple keyword-based fallback
        fallback_schemes = []
        
        # Check for specific scheme mentions
        scheme_keywords = {
            'mudra': ['mudra', '‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ'],
            'annapurna': ['annapurna', '‡§Ö‡§®‡•ç‡§®‡§™‡•Ç‡§∞‡•ç‡§£‡§æ'],
            'udyogini': ['udyogini', '‡§â‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§®‡•Ä'],
            'stand up india': ['stand up', 'standup', 'india'],
            'stree shakti': ['stree shakti', '‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§∂‡§ï‡•ç‡§§‡§ø'],
            'pmegp': ['pmegp', 'employment', '‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞'],
            'shg': ['shg', 'group', '‡§∏‡§Æ‡•Ç‡§π'],
            'food': ['food', 'catering', 'kitchen', '‡§ñ‡§æ‡§®‡§æ', '‡§∞‡§∏‡•ã‡§à'],
            'women': ['women', 'woman', '‡§Æ‡§π‡§ø‡§≤‡§æ', '‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä'],
            'small': ['small', 'micro', '‡§õ‡•ã‡§ü‡§æ', '‡§∏‡•Ç‡§ï‡•ç‡§∑‡•ç‡§Æ'],
            'business': ['business', 'enterprise', '‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø', '‡§â‡§¶‡•ç‡§Ø‡§Æ']
        }
        
        for scheme in self.loan_schemes_data:
            score = 0
            scheme_name_lower = scheme.get('name', '').lower()
            scheme_desc_lower = scheme.get('description', '').lower()
            scheme_category = scheme.get('category', '').lower()
            
            # Check scheme name and description
            for keyword_group in scheme_keywords.values():
                for keyword in keyword_group:
                    if keyword in query_lower:
                        if keyword in scheme_name_lower:
                            score += 3
                        elif keyword in scheme_desc_lower:
                            score += 2
                        elif keyword in scheme_category:
                            score += 1
            
            if score > 0:
                scheme_copy = scheme.copy()
                scheme_copy['similarity_score'] = score / 10  # Normalize score
                fallback_schemes.append(scheme_copy)
        
        # Sort by score and return top_k
        fallback_schemes.sort(key=lambda x: x['similarity_score'], reverse=True)
        return fallback_schemes[:top_k]

    def generate_loan_response(self, query: str, relevant_schemes: List[Dict[str, Any]], language: str = "en") -> str:
        """
        Generate comprehensive response using Gemini AI for conversational queries
        """
        if not self.gemini_available:
            return self._generate_fallback_response(query, relevant_schemes, language)
        
        try:
            # Prepare context from relevant schemes
            context = self._prepare_context(relevant_schemes)
            
            # Detect language if not specified
            detected_language = self._detect_language(query) if language == "auto" else language
            
            prompt = f"""
            You are Sakhi, a friendly and helpful business assistant for Indian women entrepreneurs. A user has asked about loan schemes in a conversational way: "{query}"

            Here are the relevant loan schemes based on their query:

            {context}

            Please provide a conversational, friendly response that:
            1. Acknowledges their query in a warm, understanding way
            2. Explains the most relevant loan schemes in simple, clear language
            3. Provides practical information about eligibility, amounts, and interest rates
            4. Gives step-by-step guidance on how to apply
            5. Mentions required documents and benefits
            6. Encourages them and offers to help with more specific questions
            7. Uses a conversational tone as if talking to a friend

            Important guidelines:
            - Be conversational and friendly, not formal
            - Use simple language that's easy to understand
            - Provide specific, actionable advice
            - Be encouraging and supportive
            - If they ask about a specific scheme, focus on that
            - If they ask generally, provide an overview of the best options
            - Always mention the application process and next steps

            Language: {detected_language}
            - If language is "hi" or Hindi detected, respond in Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)
            - If language is "en" or English detected, respond in English
            - If language is "ta" or Tamil detected, respond in Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)
            - If language is "ml" or Malayalam detected, respond in Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)
            - If language is "te" or Telugu detected, respond in Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)
            - If language is "kn" or Kannada detected, respond in Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)
            - If language is "gu" or Gujarati detected, respond in Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)
            - If language is "bn" or Bengali detected, respond in Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)
            - If language is "mr" or Marathi detected, respond in Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)

            Response:
            """
            
            response = self.model.generate_content(prompt)
            return response.text
            
        except Exception as e:
            logging.error(f"Failed to generate AI response: {e}")
            return self._generate_fallback_response(query, relevant_schemes, language)

    def _detect_language(self, text: str) -> str:
        """
        Detect the language of the input text
        """
        # Simple language detection based on character sets
        text_lower = text.lower()
        
        # Hindi detection
        if any(char in '‡§Ö‡§Ü‡§á‡§à‡§â‡§ä‡§è‡§ê‡§ì‡§î‡§ï‡§ñ‡§ó‡§ò‡§ô‡§ö‡§õ‡§ú‡§ù‡§û‡§ü‡§†‡§°‡§¢‡§£‡§§‡§•‡§¶‡§ß‡§®‡§™‡§´‡§¨‡§≠‡§Æ‡§Ø‡§∞‡§≤‡§µ‡§∂‡§∑‡§∏‡§π‡§ï‡•ç‡§∑‡§§‡•ç‡§∞‡§ú‡•ç‡§û‡§°‡§º‡§¢‡§º' for char in text):
            return "hi"
        
        # Tamil detection
        if any(char in '‡ÆÖ‡ÆÜ‡Æá‡Æà‡Æâ‡Æä‡Æé‡Æè‡Æê‡Æí‡Æì‡Æî‡Æï‡Æô‡Æö‡Æû‡Æü‡Æ£‡Æ§‡Æ®‡Æ™‡ÆÆ‡ÆØ‡Æ∞‡Æ≤‡Æµ‡Æ∂‡Æ∑‡Æ∏‡Æπ' for char in text):
            return "ta"
        
        # Malayalam detection
        if any(char in '‡¥Ö‡¥Ü‡¥á‡¥à‡¥â‡¥ä‡¥ã‡¥é‡¥è‡¥ê‡¥í‡¥ì‡¥î‡¥ï‡¥ñ‡¥ó‡¥ò‡¥ô‡¥ö‡¥õ‡¥ú‡¥ù‡¥û‡¥ü‡¥†‡¥°‡¥¢‡¥£‡¥§‡¥•‡¥¶‡¥ß‡¥®‡¥™‡¥´‡¥¨‡¥≠‡¥Æ‡¥Ø‡¥∞‡¥≤‡¥µ‡¥∂‡¥∑‡¥∏‡¥π' for char in text):
            return "ml"
        
        # Telugu detection
        if any(char in '‡∞Ö‡∞Ü‡∞á‡∞à‡∞â‡∞ä‡∞ã‡∞é‡∞è‡∞ê‡∞í‡∞ì‡∞î‡∞ï‡∞ñ‡∞ó‡∞ò‡∞ô‡∞ö‡∞õ‡∞ú‡∞ù‡∞û‡∞ü‡∞†‡∞°‡∞¢‡∞£‡∞§‡∞•‡∞¶‡∞ß‡∞®‡∞™‡∞´‡∞¨‡∞≠‡∞Æ‡∞Ø‡∞∞‡∞≤‡∞µ‡∞∂‡∞∑‡∞∏‡∞π' for char in text):
            return "te"
        
        # Kannada detection
        if any(char in '‡≤Ö‡≤Ü‡≤á‡≤à‡≤â‡≤ä‡≤ã‡≤é‡≤è‡≤ê‡≤í‡≤ì‡≤î‡≤ï‡≤ñ‡≤ó‡≤ò‡≤ô‡≤ö‡≤õ‡≤ú‡≤ù‡≤û‡≤ü‡≤†‡≤°‡≤¢‡≤£‡≤§‡≤•‡≤¶‡≤ß‡≤®‡≤™‡≤´‡≤¨‡≤≠‡≤Æ‡≤Ø‡≤∞‡≤≤‡≤µ‡≤∂‡≤∑‡≤∏‡≤π' for char in text):
            return "kn"
        
        # Gujarati detection
        if any(char in '‡™Ö‡™Ü‡™á‡™à‡™â‡™ä‡™ã‡™è‡™ê‡™ì‡™î‡™ï‡™ñ‡™ó‡™ò‡™ô‡™ö‡™õ‡™ú‡™ù‡™û‡™ü‡™†‡™°‡™¢‡™£‡™§‡™•‡™¶‡™ß‡™®‡™™‡™´‡™¨‡™≠‡™Æ‡™Ø‡™∞‡™≤‡™µ‡™∂‡™∑‡™∏‡™π' for char in text):
            return "gu"
        
        # Bengali detection
        if any(char in '‡¶Ö‡¶Ü‡¶á‡¶à‡¶â‡¶ä‡¶ã‡¶è‡¶ê‡¶ì‡¶î‡¶ï‡¶ñ‡¶ó‡¶ò‡¶ô‡¶ö‡¶õ‡¶ú‡¶ù‡¶û‡¶ü‡¶†‡¶°‡¶¢‡¶£‡¶§‡¶•‡¶¶‡¶ß‡¶®‡¶™‡¶´‡¶¨‡¶≠‡¶Æ‡¶Ø‡¶∞‡¶≤‡¶¨‡¶∂‡¶∑‡¶∏‡¶π' for char in text):
            return "bn"
        
        # Marathi detection
        if any(char in '‡§Ö‡§Ü‡§á‡§à‡§â‡§ä‡§ã‡§è‡§ê‡§ì‡§î‡§ï‡§ñ‡§ó‡§ò‡§ô‡§ö‡§õ‡§ú‡§ù‡§û‡§ü‡§†‡§°‡§¢‡§£‡§§‡§•‡§¶‡§ß‡§®‡§™‡§´‡§¨‡§≠‡§Æ‡§Ø‡§∞‡§≤‡§µ‡§∂‡§∑‡§∏‡§π' for char in text):
            return "mr"
        
        # Default to English
        return "en"

    def _prepare_context(self, schemes: List[Dict[str, Any]]) -> str:
        """
        Prepare context string from relevant schemes
        """
        context_parts = []
        
        for scheme in schemes:
            context_part = f"""
            Scheme: {scheme.get('name', '')}
            Description: {scheme.get('description', '')}
            Eligibility: {scheme.get('eligibility', '')}
            Maximum Amount: {scheme.get('max_amount', '')}
            Interest Rate: {scheme.get('interest_rate', '')}
            Tenure: {scheme.get('tenure', '')}
            Application Process: {scheme.get('application_process', '')}
            Required Documents: {', '.join(scheme.get('documents_required', []))}
            Benefits: {', '.join(scheme.get('benefits', []))}
            Contact: {scheme.get('contact', '')}
            """
            context_parts.append(context_part)
        
        return "\n".join(context_parts)

    def _generate_fallback_response(self, query: str, relevant_schemes: List[Dict[str, Any]], language: str) -> str:
        """
        Generate fallback response without AI for conversational queries
        """
        detected_language = self._detect_language(query) if language == "auto" else language
        
        if detected_language == "hi":
            response = f"‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® '{query}' ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å ‡§ï‡•Å‡§õ ‡§â‡§™‡§Ø‡•ã‡§ó‡•Ä ‡§≤‡•ã‡§® ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç ‡§π‡•à‡§Ç:\n\n"
        elif detected_language == "ta":
            response = f"‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æï‡Øç‡Æï‡ØÅ '{query}' ‡Æá‡Æ§‡Øã ‡Æö‡Æø‡Æ≤ ‡Æ™‡ÆØ‡Æ©‡ØÅ‡Æ≥‡Øç‡Æ≥ ‡Æï‡Æü‡Æ©‡Øç ‡Æ§‡Æø‡Æü‡Øç‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç:\n\n"
        elif detected_language == "ml":
            response = f"‡¥®‡¥Æ‡¥∏‡µç‡¥ï‡¥æ‡¥∞‡¥Ç! ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥§‡µç‡¥§‡¥ø‡¥®‡µç '{query}' ‡¥á‡¥§‡¥æ ‡¥ö‡¥ø‡¥≤ ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥™‡µç‡¥∞‡¥¶‡¥Æ‡¥æ‡¥Ø ‡¥µ‡¥æ‡¥Ø‡µç‡¥™ ‡¥™‡¥¶‡µç‡¥ß‡¥§‡¥ø‡¥ï‡µæ:\n\n"
        elif detected_language == "te":
            response = f"‡∞®‡∞Æ‡∞∏‡±ç‡∞ï‡∞æ‡∞∞‡∞Ç! ‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞ï‡±Å '{query}' ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞ï‡±ä‡∞®‡±ç‡∞®‡∞ø ‡∞â‡∞™‡∞Ø‡±ã‡∞ó‡∞ï‡∞∞‡∞Æ‡±à‡∞® ‡∞∞‡±Å‡∞£ ‡∞™‡∞•‡∞ï‡∞æ‡∞≤‡±Å:\n\n"
        elif detected_language == "kn":
            response = f"‡≤®‡≤Æ‡≤∏‡≥ç‡≤ï‡≤æ‡≤∞! ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤™‡≥ç‡≤∞‡≤∂‡≥ç‡≤®‡≥Ü‡≤ó‡≥Ü '{query}' ‡≤á‡≤≤‡≥ç‡≤≤‡≤ø ‡≤ï‡≥Ü‡≤≤‡≤µ‡≥Å ‡≤â‡≤™‡≤Ø‡≥Å‡≤ï‡≥ç‡≤§ ‡≤∏‡≤æ‡≤≤ ‡≤Ø‡≥ã‡≤ú‡≤®‡≥Ü‡≤ó‡≤≥‡≥Å:\n\n"
        elif detected_language == "gu":
            response = f"‡™®‡™Æ‡™∏‡´ç‡™§‡´á! ‡™§‡™Æ‡™æ‡™∞‡™æ ‡™™‡´ç‡™∞‡™∂‡´ç‡™® ‡™Æ‡™æ‡™ü‡´á '{query}' ‡™Ö‡™π‡´Ä‡™Ç ‡™ï‡´á‡™ü‡™≤‡™æ‡™ï ‡™â‡™™‡™Ø‡µã‡™ó‡´Ä ‡™≤‡´ã‡™® ‡™Ø‡´ã‡™ú‡™®‡™æ‡™ì ‡™õ‡´á:\n\n"
        elif detected_language == "bn":
            response = f"‡¶®‡¶Æ‡¶∏‡ßç‡¶ï‡¶æ‡¶∞! ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø '{query}' ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶â‡¶™‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶ã‡¶£ ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá:\n\n"
        elif detected_language == "mr":
            response = f"‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞! ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§∏‡§æ‡§†‡•Ä '{query}' ‡§Ø‡•á‡§•‡•á ‡§ï‡§æ‡§π‡•Ä ‡§â‡§™‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§ï‡§∞‡•ç‡§ú ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§Ü‡§π‡•á‡§§:\n\n"
        else:
            response = f"Hello! Here are some useful loan schemes for your query '{query}':\n\n"
        
        for scheme in relevant_schemes[:3]:  # Top 3 schemes
            if detected_language == "hi":
                response += f"‚Ä¢ {scheme.get('name_hi', scheme.get('name', ''))}\n"
                response += f"  - ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§∞‡§æ‡§∂‡§ø: {scheme.get('max_amount', '')}\n"
                response += f"  - ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞: {scheme.get('interest_rate', '')}\n"
                response += f"  - ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ: {scheme.get('eligibility_hi', scheme.get('eligibility', ''))}\n\n"
            elif detected_language == "ta":
                response += f"‚Ä¢ {scheme.get('name', '')}\n"
                response += f"  - ‡ÆÖ‡Æ§‡Æø‡Æï‡Æ™‡Æü‡Øç‡Æö ‡Æ§‡Øä‡Æï‡Øà: {scheme.get('max_amount', '')}\n"
                response += f"  - ‡Æµ‡Æü‡Øç‡Æü‡Æø ‡Æµ‡Æø‡Æï‡Æø‡Æ§‡ÆÆ‡Øç: {scheme.get('interest_rate', '')}\n"
                response += f"  - ‡Æ§‡Æï‡ØÅ‡Æ§‡Æø: {scheme.get('eligibility', '')}\n\n"
            elif detected_language == "ml":
                response += f"‚Ä¢ {scheme.get('name', '')}\n"
                response += f"  - ‡¥™‡¥∞‡¥Æ‡¥æ‡¥µ‡¥ß‡¥ø ‡¥§‡µÅ‡¥ï: {scheme.get('max_amount', '')}\n"
                response += f"  - ‡¥™‡¥≤‡¥ø‡¥∂ ‡¥®‡¥ø‡¥∞‡¥ï‡µç‡¥ï‡µç: {scheme.get('interest_rate', '')}\n"
                response += f"  - ‡¥Ø‡µã‡¥ó‡µç‡¥Ø‡¥§: {scheme.get('eligibility', '')}\n\n"
            elif detected_language == "te":
                response += f"‚Ä¢ {scheme.get('name', '')}\n"
                response += f"  - ‡∞ó‡∞∞‡∞ø‡∞∑‡±ç‡∞ü ‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç: {scheme.get('max_amount', '')}\n"
                response += f"  - ‡∞µ‡∞°‡±ç‡∞°‡±Ä ‡∞∞‡±á‡∞ü‡±Å: {scheme.get('interest_rate', '')}\n"
                response += f"  - ‡∞Ö‡∞∞‡±ç‡∞π‡∞§: {scheme.get('eligibility', '')}\n\n"
            elif detected_language == "kn":
                response += f"‚Ä¢ {scheme.get('name', '')}\n"
                response += f"  - ‡≤ó‡≤∞‡≤ø‡≤∑‡≥ç‡≤† ‡≤Æ‡≥ä‡≤§‡≥ç‡≤§: {scheme.get('max_amount', '')}\n"
                response += f"  - ‡≤¨‡≤°‡≥ç‡≤°‡≤ø ‡≤¶‡≤∞: {scheme.get('interest_rate', '')}\n"
                response += f"  - ‡≤Ö‡≤∞‡≥ç‡≤π‡≤§‡≥Ü: {scheme.get('eligibility', '')}\n\n"
            elif detected_language == "gu":
                response += f"‚Ä¢ {scheme.get('name', '')}\n"
                response += f"  - ‡™Æ‡™π‡™§‡´ç‡™§‡™Æ ‡™∞‡™ï‡™Æ: {scheme.get('max_amount', '')}\n"
                response += f"  - ‡™µ‡´ç‡™Ø‡™æ‡™ú ‡™¶‡™∞: {scheme.get('interest_rate', '')}\n"
                response += f"  - ‡™Ø‡´ã‡™ó‡´ç‡™Ø‡™§‡™æ: {scheme.get('eligibility', '')}\n\n"
            elif detected_language == "bn":
                response += f"‚Ä¢ {scheme.get('name', '')}\n"
                response += f"  - ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: {scheme.get('max_amount', '')}\n"
                response += f"  - ‡¶∏‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞: {scheme.get('interest_rate', '')}\n"
                response += f"  - ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡¶§‡¶æ: {scheme.get('eligibility', '')}\n\n"
            elif detected_language == "mr":
                response += f"‚Ä¢ {scheme.get('name', '')}\n"
                response += f"  - ‡§ï‡§Æ‡§æ‡§≤ ‡§∞‡§ï‡•ç‡§ï‡§Æ: {scheme.get('max_amount', '')}\n"
                response += f"  - ‡§µ‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞: {scheme.get('interest_rate', '')}\n"
                response += f"  - ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ: {scheme.get('eligibility', '')}\n\n"
            else:
                response += f"‚Ä¢ {scheme.get('name', '')}\n"
                response += f"  - Maximum Amount: {scheme.get('max_amount', '')}\n"
                response += f"  - Interest Rate: {scheme.get('interest_rate', '')}\n"
                response += f"  - Eligibility: {scheme.get('eligibility', '')}\n\n"
        
        # Add encouraging closing message
        if detected_language == "hi":
            response += "‡§Ö‡§ó‡§∞ ‡§Ü‡§™‡§ï‡•ã ‡§î‡§∞ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è ‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§∏‡•ç‡§™‡•á‡§∏‡§ø‡§´‡§ø‡§ï ‡§∏‡•ç‡§ï‡•Ä‡§Æ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡§®‡§æ ‡§π‡•à, ‡§§‡•ã ‡§Æ‡•Å‡§ù‡§∏‡•á ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç!"
        elif detected_language == "ta":
            response += "‡ÆÆ‡Øá‡Æ≤‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Æï‡Æµ‡Æ≤‡Øç ‡Æ§‡Øá‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Ææ‡Æ≤‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Øç‡Æü ‡Æ§‡Æø‡Æü‡Øç‡Æü‡Æ§‡Øç‡Æ§‡Øà‡Æ™‡Øç ‡Æ™‡Æ±‡Øç‡Æ±‡Æø ‡Æï‡Øá‡Æü‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡Æø‡Æ©‡Ææ‡Æ≤‡Øç, ‡Æé‡Æ©‡Øç‡Æ©‡Æø‡Æü‡ÆÆ‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æï‡Æ≥‡Øç ‡Æï‡Øá‡Æü‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç!"
        elif detected_language == "ml":
            response += "‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡µΩ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥µ‡µá‡¥£‡¥Æ‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥Ö‡¥≤‡µç‡¥≤‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥í‡¥∞‡µÅ ‡¥™‡µç‡¥∞‡¥§‡µç‡¥Ø‡µá‡¥ï ‡¥™‡¥¶‡µç‡¥ß‡¥§‡¥ø‡¥Ø‡µÜ‡¥ï‡µç‡¥ï‡µÅ‡¥±‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥ö‡µã‡¥¶‡¥ø‡¥ï‡µç‡¥ï‡¥£‡¥Æ‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ, ‡¥é‡¥®‡µç‡¥®‡µã‡¥ü‡µç ‡¥ö‡µã‡¥¶‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥µ‡µÅ‡¥®‡µç‡¥®‡¥§‡¥æ‡¥£‡µç!"
        elif detected_language == "te":
            response += "‡∞Æ‡∞∞‡∞ø‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å ‡∞ï‡∞æ‡∞µ‡∞æ‡∞≤‡∞Ç‡∞ü‡±á ‡∞≤‡±á‡∞¶‡∞æ ‡∞è‡∞¶‡±à‡∞®‡∞æ ‡∞®‡∞ø‡∞∞‡±ç‡∞¶‡∞ø‡∞∑‡±ç‡∞ü ‡∞™‡∞•‡∞ï‡∞Ç ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Ö‡∞°‡∞ó‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±á, ‡∞®‡∞®‡±ç‡∞®‡±Å ‡∞Ö‡∞°‡∞ó‡∞µ‡∞ö‡±ç‡∞ö‡±Å!"
        elif detected_language == "kn":
            response += "‡≤π‡≥Ü‡≤ö‡≥ç‡≤ö‡≤ø‡≤® ‡≤Æ‡≤æ‡≤π‡≤ø‡≤§‡≤ø ‡≤¨‡≥á‡≤ï‡≤æ‡≤¶‡≤∞‡≥Ü ‡≤Ö‡≤•‡≤µ‡≤æ ‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤®‡≤ø‡≤∞‡≥ç‡≤¶‡≤ø‡≤∑‡≥ç‡≤ü ‡≤Ø‡≥ã‡≤ú‡≤®‡≥Ü‡≤Ø ‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü ‡≤ï‡≥á‡≤≥‡≤≤‡≥Å ‡≤¨‡≤Ø‡≤∏‡≤ø‡≤¶‡≤∞‡≥Ü, ‡≤®‡≤®‡≥ç‡≤®‡≤®‡≥ç‡≤®‡≥Å ‡≤ï‡≥á‡≤≥‡≤¨‡≤π‡≥Å‡≤¶‡≥Å!"
        elif detected_language == "gu":
            response += "‡™µ‡™ß‡´Å ‡™Æ‡™æ‡™π‡™ø‡™§‡´Ä ‡™ú‡´ã‡™à‡™è ‡™õ‡´á ‡™Ö‡™•‡™µ‡™æ ‡™ï‡´ã‡™à ‡™ö‡´ã‡™ï‡´ç‡™ï‡™∏ ‡™Ø‡´ã‡™ú‡™®‡™æ ‡™µ‡™ø‡™∂‡´á ‡™™‡´Ç‡™õ‡™µ‡´Å‡™Ç ‡™π‡´ã‡™Ø ‡™§‡´ã, ‡™Æ‡™®‡´á ‡™™‡´Ç‡™õ‡´Ä ‡™∂‡™ï‡™æ‡™Ø ‡™õ‡´á!"
        elif detected_language == "bn":
            response += "‡¶Ü‡¶∞‡¶ì ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶® ‡¶π‡¶≤‡ßá ‡¶¨‡¶æ ‡¶ï‡ßã‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ï‡¶≤‡ßç‡¶™ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá, ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®!"
        elif detected_language == "mr":
            response += "‡§Ö‡§ß‡§ø‡§ï ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§π‡§µ‡•Ä ‡§Ö‡§∏‡•á‡§≤ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ‡§π‡•Ä ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§Ø‡•ã‡§ú‡§®‡•á‡§¨‡§¶‡•ç‡§¶‡§≤ ‡§µ‡§ø‡§ö‡§æ‡§∞‡§£‡•á ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞, ‡§Æ‡§≤‡§æ ‡§µ‡§ø‡§ö‡§æ‡§∞‡•Ç ‡§∂‡§ï‡§§‡§æ!"
        else:
            response += "If you need more information or want to ask about any specific scheme, feel free to ask me!"
        
        return response

    def process_loan_query(self, query: str, language: str = "en") -> Dict[str, Any]:
        """
        Main method to process loan queries using RAG with conversational support
        """
        try:
            # Load data if not already loaded
            if not self.loan_schemes_data:
                self.load_schemes_data()
            
            # Auto-detect language if not specified or if "auto" is passed
            if language == "auto" or not language:
                detected_language = self._detect_language(query)
            else:
                detected_language = language
            
            # Search for relevant schemes with conversational query support
            relevant_schemes = self.search_schemes(query, top_k=5)
            
            # Generate response with detected language
            response_text = self.generate_loan_response(query, relevant_schemes, detected_language)
            
            return {
                "success": True,
                "query": query,
                "response": response_text,
                "relevant_schemes": relevant_schemes,
                "total_schemes_found": len(relevant_schemes),
                "language": detected_language,
                "detected_language": detected_language
            }
            
        except Exception as e:
            logging.error(f"Error processing loan query: {e}")
            return {
                "success": False,
                "error": str(e),
                "query": query,
                "response": "Sorry, I couldn't process your loan query at the moment. Please try again later.",
                "relevant_schemes": [],
                "total_schemes_found": 0,
                "language": language,
                "detected_language": self._detect_language(query) if query else "en"
            } 